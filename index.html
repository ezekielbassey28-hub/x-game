<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>X vs O - Real-Time Multiplayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    body {
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAw4D4zwUe2Qstk30XLd6eO_duoXDlCp1k",
      authDomain: "xo-game-multiplayer-538e5.firebaseapp.com",
      databaseURL: "https://xo-game-multiplayer-538e5-default-rtdb.firebaseio.com",
      projectId: "xo-game-multiplayer-538e5",
      storageBucket: "xo-game-multiplayer-538e5.firebasestorage.app",
      messagingSenderId: "50264639507",
      appId: "1:50264639507:web:be7d9a2a27096f036517e6",
      measurementId: "G-M17J9WXZ4W"
    };

    let firebaseInitialized = false;
    let database = null;

    const initializeFirebase = () => {
      if (firebaseInitialized) return;
      try {
        if (!window.firebase) {
          console.error('Firebase library not loaded');
          return;
        }
        
        // Check if app already initialized
        if (window.firebase.apps && window.firebase.apps.length > 0) {
          database = window.firebase.database(window.firebase.apps[0]);
        } else {
          const app = window.firebase.initializeApp(firebaseConfig);
          database = window.firebase.database(app);
        }
        
        firebaseInitialized = true;
        console.log('Firebase initialized successfully');
      } catch (e) {
        console.error("Firebase initialization error:", e);
      }
    };

    function ArcadeXO() {
      const [gameState, setGameState] = useState('menu');
      const [board, setBoard] = useState(Array(9).fill(null));
      const [isXNext, setIsXNext] = useState(true);
      const [scores, setScores] = useState({ x: 0, o: 0 });
      const [stats, setStats] = useState({ xWins: 0, oWins: 0, draws: 0, totalGames: 0 });
      const [playerNames, setPlayerNames] = useState({ x: 'Player 1', o: 'Player 2' });
      const [nameInputs, setNameInputs] = useState({ x: '', o: '' });
      const [soundEnabled, setSoundEnabled] = useState(true);
      const [showSettings, setShowSettings] = useState(false);
      const [winStreak, setWinStreak] = useState({ x: 0, o: 0 });
      const [achievements, setAchievements] = useState([]);
      const [positionHeatmap, setPositionHeatmap] = useState(Array(9).fill(0));
      const [leaderboard, setLeaderboard] = useState([]);
      const [gameStartTime, setGameStartTime] = useState(null);
      const [roomCode, setRoomCode] = useState('');
      const [playerSymbol, setPlayerSymbol] = useState(null);
      const [connectedPlayers, setConnectedPlayers] = useState(0);
      const [gameId, setGameId] = useState('');
      const [waitingForOpponent, setWaitingForOpponent] = useState(false);
      const timerRef = useRef(null);
      const dbRef = useRef(null);

      const ACHIEVEMENTS = {
        firstWin: { id: 'firstWin', name: 'üéâ First Victory', desc: 'Win your first game' },
        speedrun: { id: 'speedrun', name: '‚ö° Speed Demon', desc: 'Win in under 30 seconds' },
        perfectGame: { id: 'perfectGame', name: 'üëë Perfect Game', desc: 'Win without opponent scoring' },
        comebackKing: { id: 'comebackKing', name: 'üîÑ Comeback King', desc: 'Win after being 0-2 down' },
        tenWins: { id: 'tenWins', name: 'üèÜ Decade', desc: 'Reach 10 wins' },
        fiftyWins: { id: 'fiftyWins', name: 'üéñÔ∏è Champion', desc: 'Reach 50 wins' },
        fiveStreak: { id: 'fiveStreak', name: 'üî• On Fire', desc: 'Get a 5-game win streak' },
        centerMaster: { id: 'centerMaster', name: 'üéØ Center Master', desc: 'Win by playing center' },
        blitzKing: { id: 'blitzKing', name: '‚ö° Blitz King', desc: 'Win a Blitz match' },
        cornerSpecialist: { id: 'cornerSpecialist', name: 'üìê Corner Specialist', desc: 'Win using 3+ corners' },
      };

      const playSound = (type) => {
        if (!soundEnabled) return;
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          if (type === 'move') {
            oscillator.frequency.value = 400;
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
          } else if (type === 'win') {
            oscillator.frequency.value = 600;
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
          }
        } catch (e) {}
      };

      const calculateWinner = (squares) => {
        const lines = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
        for (let line of lines) {
          const [a, b, c] = line;
          if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
            return { winner: squares[a], line };
          }
        }
        return { winner: null, line: null };
      };

      const generateRoomCode = () => {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
      };

      const createGame = async () => {
        initializeFirebase();
        const newGameId = generateRoomCode();
        setGameId(newGameId);
        setRoomCode(newGameId);
        setPlayerSymbol('X');
        setPlayerNames({ x: nameInputs.x || 'Player 1', o: 'Waiting...' });
        setWaitingForOpponent(true);
        setGameState('waiting');

        if (database) {
          try {
            const gameRef = database.ref(`games/${newGameId}`);
            await gameRef.set({
              board: Array(9).fill(null),
              turn: 'X',
              player_x: nameInputs.x || 'Player 1',
              player_o: null,
              status: 'waiting',
              created_at: new Date().getTime(),
            });

            // Listen for opponent joining
            gameRef.on('value', (snapshot) => {
              const data = snapshot.val();
              if (data) {
                // Convert empty strings back to null
                const cleanBoard = (data.board || Array(9).fill(null)).map(cell => 
                  cell === '' || cell === undefined ? null : cell
                );
                setBoard(cleanBoard);
                setIsXNext(data.turn === 'X');
                
                // When opponent joins, update names and start game
                if (data.player_o && data.player_o !== 'Waiting...') {
                  setPlayerNames({ x: data.player_x, o: data.player_o });
                  setWaitingForOpponent(false);
                  
                  // Auto transition to playing state
                  setTimeout(() => {
                    setGameState('playing');
                  }, 500);
                }
                
                if (data.winner) {
                  endMultiplayerGame(data.winner);
                }
              }
            });

            dbRef.current = gameRef;
          } catch (error) {
            console.error('Error creating game:', error);
            alert('Error creating game: ' + error.message);
          }
        } else {
          console.error('Database not initialized');
        }
      };

      const joinGame = async () => {
        initializeFirebase();
        if (roomCode.length !== 6) {
          alert('Room code must be 6 characters!');
          return;
        }
        
        if (!database) {
          alert('Firebase not connected. Please try again.');
          return;
        }

        try {
          const gameRef = database.ref(`games/${roomCode}`);
          const snapshot = await gameRef.once('value');
          
          if (snapshot.exists()) {
            const data = snapshot.val();
            if (!data.player_o) {
              setGameId(roomCode);
              setPlayerSymbol('O');
              setPlayerNames({ x: data.player_x, o: nameInputs.o || 'Player 2' });
              setBoard(data.board || Array(9).fill(null));
              setGameState('playing');

              await gameRef.update({
                player_o: nameInputs.o || 'Player 2',
                status: 'playing'
              });

              gameRef.on('value', (snapshot) => {
                const updatedData = snapshot.val();
                if (updatedData) {
                  // Convert empty strings back to null
                  const cleanBoard = (updatedData.board || Array(9).fill(null)).map(cell => 
                    cell === '' || cell === undefined ? null : cell
                  );
                  setBoard(cleanBoard);
                  setIsXNext(updatedData.turn === 'X');
                  if (updatedData.winner) {
                    endMultiplayerGame(updatedData.winner);
                  }
                }
              });

              dbRef.current = gameRef;
            } else {
              alert('Room is full! Game already started.');
            }
          } else {
            alert('Room code not found. Double-check the code!');
          }
        } catch (error) {
          console.error('Error joining game:', error);
          alert('Error joining game: ' + error.message);
        }
      };

      const makeMove = async (index) => {
        if (board[index] || gameState !== 'playing') return;
        
        // Check if it's your turn
        const yourTurn = (playerSymbol === 'X' && isXNext) || (playerSymbol === 'O' && !isXNext);
        if (!yourTurn) {
          alert('Not your turn!');
          return;
        }

        // Create clean board - convert ALL undefined/null to empty string or handle properly
        const newBoard = Array(9).fill(null);
        for (let i = 0; i < board.length; i++) {
          newBoard[i] = board[i] === null || board[i] === undefined ? null : board[i];
        }
        newBoard[index] = playerSymbol;
        playSound('move');

        const { winner } = calculateWinner(newBoard);
        const isFull = newBoard.every(cell => cell !== null);

        if (database && dbRef.current) {
          try {
            // Create a clean object with no undefined values
            const cleanBoard = newBoard.map(cell => cell === null || cell === undefined ? '' : cell);
            
            const updateData = {
              board: cleanBoard,
              turn: playerSymbol === 'X' ? 'O' : 'X'
            };
            
            // Only set winner if game ended
            if (winner) {
              updateData.winner = winner;
            } else if (isFull) {
              updateData.winner = 'Draw';
            }
            
            await dbRef.current.update(updateData);
          } catch (error) {
            console.error('Error making move:', error);
            console.log('Board:', board);
            console.log('New Board:', newBoard);
            alert('Error making move: ' + error.message);
          }
        }
      };

      const endMultiplayerGame = (winner) => {
        setGameState('ended');
        playSound('win');
        updateMultiplayerStats(winner);
      };

      const updateMultiplayerStats = (winner) => {
        setStats((s) => ({
          ...s,
          xWins: winner === 'X' ? s.xWins + 1 : s.xWins,
          oWins: winner === 'O' ? s.oWins + 1 : s.oWins,
          draws: winner === 'Draw' ? s.draws + 1 : s.draws,
          totalGames: s.totalGames + 1,
        }));
      };

      const resetGame = () => {
        setGameState('menu');
        setBoard(Array(9).fill(null));
        setIsXNext(true);
        setPlayerSymbol(null);
        setGameId('');
        setRoomCode('');
        setWaitingForOpponent(false);
        if (dbRef.current) {
          dbRef.current.off();
        }
      };

      const copyRoomCode = () => {
        navigator.clipboard.writeText(roomCode);
        alert('Room code copied to clipboard!');
      };

      const getHeatmapColor = (index) => {
        const max = Math.max(...positionHeatmap);
        const intensity = max > 0 ? positionHeatmap[index] / max : 0;
        if (intensity === 0) return 'opacity-0';
        if (intensity < 0.33) return 'bg-blue-600 bg-opacity-20';
        if (intensity < 0.66) return 'bg-blue-600 bg-opacity-40';
        return 'bg-blue-600 bg-opacity-60';
      };

      const renderSquare = (index) => {
        return (
          <button key={index} onClick={() => makeMove(index)} className={`relative w-20 h-20 border-2 text-4xl font-black transition transform hover:scale-105 active:scale-95 bg-slate-700 hover:bg-slate-600 border-purple-500`}>
            <div className={`absolute inset-0 ${getHeatmapColor(index)} rounded`} />
            <span className={`relative z-10 ${board[index] === 'X' ? 'text-cyan-400' : board[index] === 'O' ? 'text-pink-400' : ''}`}>{board[index]}</span>
          </button>
        );
      };

      const { winner: gameWinner } = calculateWinner(board);
      const isBoardFull = board.every((cell) => cell !== null);
      const gameOver = gameWinner || isBoardFull;

      return (
        <div className="w-full min-h-screen flex flex-col items-center justify-center gap-4 font-mono p-4 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
          {gameState === 'menu' && (
            <div className="text-center max-w-2xl">
              <h1 className="text-6xl font-black text-cyan-400 mb-2 tracking-wider">X vs O</h1>
              <p className="text-xl text-purple-300 mb-8">üåê Real-Time Multiplayer</p>

              <div className="space-y-4 mb-8 max-w-md mx-auto">
                <div>
                  <label className="block text-sm mb-2">Your Name:</label>
                  <input type="text" placeholder="Enter your name" value={nameInputs.x} onChange={(e) => setNameInputs({ ...nameInputs, x: e.target.value })} className="w-full px-4 py-2 bg-slate-800 border border-purple-500 rounded text-white" />
                </div>

                <button onClick={createGame} className="w-full px-6 py-3 bg-cyan-500 hover:bg-cyan-400 text-black font-bold rounded-lg transition transform hover:scale-105">
                  ‚ûï Create Game Room
                </button>

                <div className="border-t border-purple-500 py-4">
                  <p className="text-sm text-purple-300 mb-4">OR</p>
                  <input type="text" placeholder="Enter room code" value={roomCode} onChange={(e) => setRoomCode(e.target.value.toUpperCase())} maxLength="6" className="w-full px-4 py-2 bg-slate-800 border border-purple-500 rounded text-white mb-4 text-center text-2xl tracking-widest" />
                  <button onClick={joinGame} className="w-full px-6 py-3 bg-pink-500 hover:bg-pink-400 text-black font-bold rounded-lg transition transform hover:scale-105">
                    üîó Join Game Room
                  </button>
                </div>
              </div>
            </div>
          )}

          {gameState === 'waiting' && (
            <div className="text-center max-w-md">
              <h1 className="text-4xl font-black text-cyan-400 mb-4">Game Room Created! üéÆ</h1>
              <div className="bg-slate-800 p-6 rounded-lg mb-6 border-2 border-cyan-400">
                <p className="text-sm text-purple-300 mb-2">Room Code:</p>
                <p className="text-5xl font-black text-cyan-400 mb-4 tracking-widest">{roomCode}</p>
                <button onClick={copyRoomCode} className="w-full px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-black font-bold rounded">
                  üìã Copy Code
                </button>
              </div>

              <p className="text-xl text-purple-300 mb-4">Share this code with your friend!</p>
              <p className="text-sm text-gray-400 mb-6">You are playing as: <span className="text-cyan-400 font-bold">X</span></p>

              <div className="animate-pulse text-lg text-yellow-400">
                ‚è≥ Waiting for opponent to join...
              </div>

              <button onClick={resetGame} className="mt-8 px-6 py-2 bg-red-600 hover:bg-red-500 font-bold rounded-lg">
                Cancel
              </button>
            </div>
          )}

          {(gameState === 'playing' || gameState === 'ended') && (
            <div className="flex flex-col items-center gap-4 w-full">
              <div className="w-full max-w-md">
                <div className="flex justify-between items-center mb-4">
                  <h1 className="text-3xl font-black text-cyan-400">X vs O</h1>
                  <button onClick={() => setShowSettings(!showSettings)} className="px-3 py-2 bg-purple-600 hover:bg-purple-500 rounded text-sm">‚öôÔ∏è</button>
                </div>

                <div className="grid grid-cols-2 gap-4 mb-4 text-center">
                  <div className={`p-3 rounded-lg ${playerSymbol === 'X' ? 'bg-cyan-600' : 'bg-slate-700'}`}>
                    <p className="text-xs text-gray-300">You</p>
                    <p className="text-xl font-bold text-cyan-400">{playerSymbol === 'X' ? playerNames.x : playerNames.o}</p>
                    <p className="text-sm text-cyan-300">{playerSymbol}</p>
                  </div>
                  <div className={`p-3 rounded-lg ${playerSymbol === 'O' ? 'bg-pink-600' : 'bg-slate-700'}`}>
                    <p className="text-xs text-gray-300">Opponent</p>
                    <p className="text-xl font-bold text-pink-400">{playerSymbol === 'X' ? playerNames.o : playerNames.x}</p>
                    <p className="text-sm text-pink-300">{playerSymbol === 'X' ? 'O' : 'X'}</p>
                  </div>
                </div>

                {!gameOver && (
                  <div className="text-center mb-4 p-3 bg-slate-800 rounded">
                    <p className="text-sm text-purple-300">
                      {isXNext ? playerNames.x : playerNames.o}'s Turn
                    </p>
                    <p className={`text-2xl font-black ${isXNext ? 'text-cyan-400' : 'text-pink-400'}`}>
                      {isXNext ? 'X' : 'O'}
                    </p>
                  </div>
                )}

                <div className="grid grid-cols-3 gap-2 p-4 bg-slate-900 border-4 border-purple-500 rounded-lg mb-4">
                  {[0, 1, 2, 3, 4, 5, 6, 7, 8].map((i) => renderSquare(i))}
                </div>

                {gameOver && (
                  <div className="text-center mb-4">
                    <p className="text-3xl font-black mb-4">
                      {gameWinner ? <span className={gameWinner === 'X' ? 'text-cyan-400' : 'text-pink-400'}>{gameWinner === playerSymbol ? 'YOU WIN! üéâ' : 'YOU LOST üò¢'}</span> : <span className="text-yellow-400">DRAW! ü§ù</span>}
                    </p>
                    <button onClick={resetGame} className="w-full px-6 py-2 bg-cyan-500 hover:bg-cyan-400 text-black font-bold rounded-lg">
                      Back to Menu
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ArcadeXO />);
  </script>
</body>
</html>
